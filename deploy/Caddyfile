{$DOMAIN}, www.{$DOMAIN} {
  encode zstd gzip

  header {
    # Baseline security headers (keep CSP conservative to avoid breaking Next.js).
    -Server
    X-Content-Type-Options nosniff
    Referrer-Policy strict-origin-when-cross-origin
    X-Frame-Options DENY
    Permissions-Policy "geolocation=(), camera=(), microphone=()"
    Strict-Transport-Security "max-age=31536000"
    Content-Security-Policy "default-src 'self'; base-uri 'none'; form-action 'self'; frame-ancestors 'none'; img-src 'self' data: https:; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self' https:; font-src 'self' data:; object-src 'none'"
  }

  @www {
    host www.{$DOMAIN}
  }
  redir @www https://{$DOMAIN}{uri} permanent

  # Admin endpoints should not be public. Default recommended access:
  # - Allow only localhost and use SSH port forwarding for admin actions.
  @adminDenied {
    path /admin/*
    not remote_ip {$ADMIN_ALLOWED_IPS}
  }
  handle @adminDenied {
    respond "Forbidden" 403
  }

  @admin {
    path /admin/*
  }
  handle @admin {
    reverse_proxy api:3001 {
      # Override forwarded headers to prevent spoofing (use connection info).
      header_up X-Forwarded-For {remote_host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
    }
  }

  @api {
    # API endpoints exposed on the public domain.
    #
    # IMPORTANT: Keep these specific to avoid clashing with Next.js pages like:
    # - /b/[slug] (board page)
    # - /search (search page)
    path /health /boards /b/*/threads* /threads/* /agent/*
  }

  handle @api {
    reverse_proxy api:3001 {
      # Override forwarded headers to prevent spoofing (use connection info).
      header_up X-Forwarded-For {remote_host}
      header_up X-Real-IP {remote_host}
      header_up X-Forwarded-Proto {scheme}
      header_up X-Forwarded-Host {host}
    }
  }

  handle {
    reverse_proxy web:3000
  }

  log {
    output stdout
    format console
  }
}
